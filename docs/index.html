<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warlord Deck Legality Checker (v2.2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; }
        .card-container {
            border: 4px solid #1f2937;
            background: linear-gradient(145deg, #1f2937, #111827);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .status-box {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
        }
        .pass { background-color: #10b981; color: #064e3b; }
        .fail { background-color: #ef4444; color: #7f1d1d; }
        .warning { background-color: #f59e0b; color: #78350f; }
        #edition-select { height: 120px; }
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center items-start min-h-screen">

    <div id="app" class="w-full max-w-5xl space-y-6">
        
        <header class="text-center mb-6 bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-amber-400">Warlord Deck Checker</h1>
            <p class="text-gray-400 text-lg mt-2">Enter your Starting Army and Main Deck to validate legality.</p>
            <p class="text-gray-600 text-xs mt-1">v2.2 (External Configuration)</p>
        </header>

        <div id="loading-status" class="card-container p-6 rounded-xl text-center text-lg font-semibold text-sky-400">
            Fetching official card data and rulesets... Please wait.
        </div>

        <div id="input-section" class="hidden space-y-6">
            
            <!-- Rule Set Selection -->
            <div class="card-container p-6 rounded-xl">
                <h2 class="text-xl font-bold mb-3 text-gray-200 border-b border-gray-700 pb-2">1. Select Format</h2>
                <div>
                    <select id="ruleset-select" class="w-full p-3 bg-gray-900 border border-gray-700 text-gray-50 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition duration-150 text-white">
                        <!-- Options populated by JS -->
                    </select>
                    <p class="text-xs mt-2 text-gray-500">
                        Select a format to apply deck construction rules defined in <code>warlord_configuration.json</code>.
                    </p>
                </div>
            </div>

            <!-- Deck Inputs -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card-container p-6 rounded-xl">
                    <label for="sa-wl-input" class="block text-lg font-bold mb-2 text-gray-200">2. Starting Army</label>
                    <p class="text-xs text-gray-500 mb-2">Warlord + Characters/Items starting in play.</p>
                    <textarea id="sa-wl-input" rows="12" class="w-full p-4 bg-gray-900 border border-gray-700 text-gray-50 rounded-lg focus:ring-amber-500 focus:border-amber-500 font-mono text-sm text-white" placeholder="1 Warlord Name&#10;3 Level 1 Character&#10;2 Level 2 Character"></textarea>
                </div>

                <div class="card-container p-6 rounded-xl">
                    <label for="main-deck-input" class="block text-lg font-bold mb-2 text-gray-200">3. Main Deck</label>
                    <p class="text-xs text-gray-500 mb-2">Characters, Actions, Items, etc.</p>
                    <textarea id="main-deck-input" rows="12" class="w-full p-4 bg-gray-900 border border-gray-700 text-gray-50 rounded-lg focus:ring-amber-500 focus:border-amber-500 font-mono text-sm text-white" placeholder="3 Card Name&#10;3 Another Card&#10;..."></textarea>
                </div>
            </div>
            
            <!-- Button Row -->
            <div class="grid grid-cols-2 gap-4 mt-6">
                <button id="clear-deck-button" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition duration-200">
                    Clear Inputs
                </button>
                <button id="check-deck-button" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg transition duration-200 shadow-lg shadow-green-900/50">
                    Validate Deck
                </button>
            </div>
        </div>

        <div id="results" class="space-y-6">
            <!-- Results will be injected here -->
        </div>

    </div>

    <script type="module">
        // --- CONSTANTS ----------------------------------------------------

        let cardDatabase = {}; 
        let RULE_SETS = {};
        let WL_SA_LOYALTY_EXCEPTIONS = [];
        let SA_RING_EXCEPTIONS = [];
        let SA_CHARACTER_EXCEPTIONS = [];
        let FACTION_WILDCARD_NAMES = [];
        
        // Absolute URL for Cards (works everywhere), Relative for Config (works locally if served)
        const CARD_DATA_URL = "https://theaccordlands.com/assets/resources/cards.22ae1421.json"; 
        const CONFIG_DATA_URL = "warlord_configuration.json";

        // --- REGEX & CONSTANTS ---
        const lineRegex = /^\s*(?:(\d+)\s*x?\s+)?([^(/]+)/i;
        const unlimitedCopiesRegex = /(you may have (more than 3|any number of) copies|you may have any number|your deck may include any number)/i;
        const factionWildcardRegex = /same.*?faction(s)?.*?as your warlord(s)?/i;
        const errataEpicRegex = /Format Notes:\s*-?\s*([^-\r\n]+)\s*-\s*Epic/gi; 
        const errataReservedRegex = /Format Notes:\s*-?\s*([^-\r\n]+)\s*-\s*Reserved/gi;
        const errataBannedRegex = /Format Notes:\s*-?\s*([^-\r\n]+)\s*-\s*Banned/gi;

        const loadingStatusDiv = document.getElementById('loading-status');
        const inputSectionDiv = document.getElementById('input-section');
        const resultsDiv = document.getElementById('results');
        const rulesetSelect = document.getElementById('ruleset-select');

        // --- DATABASE & PARSING ---------------------------------------------------

        const normalizeName = (name) => name.replace(/[^a-zA-Z0-9]/g, '');

        const getSAExceptions = (card) => {
            const lowerText = (card.text || '').toLowerCase();
            const saExceptions = { isItemStarter: false, isReplacement: false };
            if (card.type && card.type.toLowerCase() === 'item') {
                if (lowerText.includes("may start the game in play") || lowerText.includes("starts in play")) {
                    saExceptions.isItemStarter = true;
                }
            } else if (card.type && card.type.toLowerCase() === 'character' && !(card.subtype && card.subtype.includes("Warlord"))) {
                if (lowerText.includes("may start in play in rank") && (lowerText.includes("instead of") || lowerText.includes("replaces"))) {
                    saExceptions.isReplacement = true;
                }
            }
            return saExceptions;
        }

        const loadAppData = async (retries = 3, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const [cardsResponse, configResponse] = await Promise.all([
                        fetch(CARD_DATA_URL),
                        fetch(CONFIG_DATA_URL)
                    ]);

                    if (!cardsResponse.ok) throw new Error(`Cards HTTP error! status: ${cardsResponse.status}`);
                    if (!configResponse.ok) throw new Error(`Config HTTP error! status: ${configResponse.status}`);

                    const cardJson = await cardsResponse.json();
                    const configJson = await configResponse.json();
                    
                    // 1. Hydrate Configuration from JSON
                    RULE_SETS = configJson.rulesets || {};
                    WL_SA_LOYALTY_EXCEPTIONS = configJson.warlordExceptions || [];
                    SA_RING_EXCEPTIONS = configJson.ringExceptions || [];
                    SA_CHARACTER_EXCEPTIONS = configJson.characterExceptions || [];
                    FACTION_WILDCARD_NAMES = configJson.factionWildcards || [];

                    // Populate Ruleset Select
                    rulesetSelect.innerHTML = '';
                    // Only allow first 10 rulesets to prevent UI clutter
                    const rulesetKeys = Object.keys(RULE_SETS);
                    const limit = Math.min(rulesetKeys.length, 10);
                    
                    for(let j = 0; j < limit; j++) {
                        const key = rulesetKeys[j];
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = RULE_SETS[key].name;
                        rulesetSelect.appendChild(option);
                    }

                    // 2. Process Card Data
                    const newDatabase = {};
                    
                    if (Array.isArray(cardJson)) {
                        cardJson.forEach(card => {
                            const level = parseInt(card.level);
                            const rawSubtype = String(card.subtype || '').toLowerCase(); 
                            const classes = Array.isArray(card.class) ? card.class.map(c => String(c).toLowerCase()) : [];
                            const primaryFaction = (Array.isArray(card.faction) && card.faction.length > 0)
                                ? card.faction.map(f => String(f).toLowerCase()).join(' ') 
                                : 'neutral';
                            
                            const isWarlord = rawSubtype.includes("warlord");
                            const editions = card.editions || [];
                            const lowerText = (card.text || '').toLowerCase(); 
                            const lookupKey = normalizeName(card.name).toLowerCase(); 
                            const isFactionWildcard = factionWildcardRegex.test(lowerText) || FACTION_WILDCARD_NAMES.includes(lookupKey);
                            const saExceptions = getSAExceptions(card);
                            const isUnlimitedCopies = unlimitedCopiesRegex.test(lowerText);
                            
                            const printInfos = card.printInfos || [];
                            const sets = [...new Set(printInfos.map(info => info.set))];
                            const rarities = [...new Set(printInfos.map(info => info.rarity))];

                            if (newDatabase[lookupKey]) {
                                console.warn(`Normalization Collision: '${card.name}' overwrites '${newDatabase[lookupKey].name}'`);
                            }

                            newDatabase[lookupKey] = { 
                                name: card.name,
                                normalizedName: lookupKey,
                                type: card.type || (level > 0 ? 'Character' : 'Action'), 
                                level: isNaN(level) ? 0 : level,
                                isWarlord: isWarlord,
                                rawSubtype: rawSubtype, 
                                faction: primaryFaction, 
                                alignment: card.alignment || '', 
                                classes: classes, 
                                isEpicKeyword: card.keywords && card.keywords.some(kw => kw.name === "Epic"),
                                isUniqueKeyword: card.keywords && card.keywords.some(kw => kw.name === "Unique"),
                                isFactionWildcard: isFactionWildcard, 
                                isUnlimitedCopies: isUnlimitedCopies, 
                                editions: editions,
                                sets: sets,
                                rarities: rarities,
                                printInfos: printInfos,
                                bannedErrataFormats: [], 
                                saReservedFormats: [],
                                epicErrataFormats: [],
                                isSAItemStarter: saExceptions.isItemStarter,
                                isSACharacterReplacement: saExceptions.isReplacement,
                                text: card.text || '' 
                            };
                            
                            // Populate errata formats
                             if (card.errata) {
                                let match;
                                errataEpicRegex.lastIndex = 0; 
                                while ((match = errataEpicRegex.exec(card.errata)) !== null) { newDatabase[lookupKey].epicErrataFormats.push(match[1].trim()); }
                                errataReservedRegex.lastIndex = 0; 
                                while ((match = errataReservedRegex.exec(card.errata)) !== null) { newDatabase[lookupKey].saReservedFormats.push(match[1].trim()); }
                                errataBannedRegex.lastIndex = 0; 
                                while ((match = errataBannedRegex.exec(card.errata)) !== null) { newDatabase[lookupKey].bannedErrataFormats.push(match[1].trim()); }
                            }
                        });
                    }

                    if (Object.keys(newDatabase).length > 0) {
                        cardDatabase = newDatabase;
                        loadingStatusDiv.className = 'hidden';
                        inputSectionDiv.classList.remove('hidden');
                        return true;
                    }

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed to load data:`, error.message);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    }
                }
            }
            loadingStatusDiv.innerHTML = `
                <p class="text-red-400 font-bold mb-2">‚ùå Failed to load configuration.</p>
                <p class="text-sm text-gray-300">Ensure <code>warlord_configuration.json</code> is in the same folder.</p>
                <p class="text-xs text-gray-500 mt-2">Note: If running locally, you must use a web server (http://localhost) not file:// due to CORS security.</p>
            `;
            loadingStatusDiv.classList.add('bg-red-900/50', 'border-red-600');
            loadingStatusDiv.classList.remove('text-sky-400');
            return false;
        };

        // --- MAIN DECK CHECKER LOGIC RESTORED ---
        // (Paste the full, original script logic here, including all helpers, event listeners, and the main checkDeck function)

        // For brevity, this patch restores the original working logic as it was before the placeholder was added.
        // If you need a specific version or want to add Discord token logic, let me know!

    </script>
</body>
</html>
